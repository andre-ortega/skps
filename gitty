#!/bin/bash
# Dependencies
#   inotifytools

set -eou pipefail

GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

notify="inotifywait @./.git @./node_modules -r -e close_write . &> /dev/null"
gstat="git status -s"

error() {
  echo "$@" 1>&2
}

function run {
  flag=0

  clear

  if [ -z "$($gstat)" -a $? == 0 ]
  then

    count=0
    while IFS= read -r line
    do

      if (( count == 0 ))
      then
        echo -e "${GREEN}$(git rev-parse --show-toplevel)${NC}"
        echo $line
      fi

      if (( count == 1 ))
      then

        if [[ ${line:41} == "in'." ]]
        then
          echo -e "${GREEN}Up to date.${NC}"
        else
          echo "${line:41}"
        fi
      fi

      if (( count == 2 ))
      then
        flag=1
      fi
      count=$((count+1))
    done < <(git status)

    if (( flag == 0 ))
    then
      echo -e "${YELLOW}Remote repository not set.${NC}"
    fi

  else
    $gstat

    if [ $? != 0 ]
    then
      echo -e "${YELLOW}Exited.${NC}"
      exit
    fi
  fi
}

if test -d $PWD/.git; then
  while eval "$notify"; do
      clear
      echo "."
      sleep 1
      clear
      echo ".."
      sleep 1
      clear
      run
  done
else
  error "Not a project root."
fi
