#!/bin/bash
# Dependencies
#   tree
#   inotifytools
#   bat

notify="inotifywait @./node_modules -r -e close_write -e access . &> /dev/null"
cmd="git status -s"
cmd2="git --no-pager diff HEAD | \
  bat \
  --paging=never \
  -n"

cmd3="bat --paging=never \
  --wrap=never \
  -d \
  -p"

function run {

  clear
  sleep .15

  if [ -z "$($cmd)" ]
  then
    count=0
    while IFS= read -r line
    do
      if (( count == 0 ))
      then
        echo $line
      fi
      if (( count == 1 ))
      then
        echo "${line:41}"
      fi
      count=$((count+1))
    done < <(git status)
  else
    echo " ------"
    $cmd
    echo " ------"

    while IFS= read -r line
    do
      echo "${line:3}"
      eval "$cmd3 ${line:3}"
    done < <($cmd)
  fi

}


run

while eval "$notify"; do
    run
done
